# ğŸ—ï¸ Cáº£i Thiá»‡n Kiáº¿n TrÃºc - TrÆ°á»›c & Sau

## ğŸ“Š Tráº¡ng ThÃ¡i Hiá»‡n Táº¡i vs. Tráº¡ng ThÃ¡i Khuyáº¿n Nghá»‹

---

## ğŸ”´ KIáº¾N TRÃšC HIá»†N Táº I (Váº¥n Äá»)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Há»† THá»NG HIá»†N Táº I                             â”‚
â”‚                      (CÃ³ Váº¥n Äá» NghiÃªm Trá»ng)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    KhÃ¡ch hÃ ng                                SePay
       â”‚                                         â”‚
       â”‚ 1. Táº¡o ÄÆ¡n HÃ ng                         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
       â”‚                  â–¼                      â”‚
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚           â”‚   Node.js   â”‚               â”‚
       â”‚           â”‚   Backend   â”‚               â”‚
       â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                  â”‚                      â”‚
       â”‚                  â”‚ 2. Táº¡o Task          â”‚
       â”‚                  â–¼                      â”‚
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚           â”‚   MySQL     â”‚               â”‚
       â”‚           â”‚  Database   â”‚               â”‚
       â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
       â”‚                  â”‚                      â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚ 3. Tráº£ Vá» QR                            â”‚
       â”‚                                         â”‚
       â”‚ 4. KhÃ¡ch thanh toÃ¡n                     â”‚
       â”‚ qua app banking                         â”‚
       â”‚                                         â”‚
       â”‚                              5. Webhook â”‚
       â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â–¼
       â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚   Node.js   â”‚
       â”‚                       â”‚   Backend   â”‚
       â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 6. Cáº­p nháº­t: paid â†’ processing
       â”‚                              â–¼
       â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚   MySQL     â”‚
       â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 7. Node.js Worker
       â”‚                              â”‚    Ä‘Äƒng kÃ½ vÃ o Udemy
       â”‚                              â”‚
       â”‚                              â”‚ 8. Cáº­p nháº­t: processing â†’ enrolled
       â”‚                              â–¼
       â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚   MySQL     â”‚
       â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚
       â”‚                              â”‚ âŒ POLLING (má»—i 10s)
       â”‚                              â”‚
       â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚   Python    â”‚ â—„â”€â”€â”€ âš ï¸ WORKER ÄÆ N
       â”‚                       â”‚   Worker    â”‚      (1 task táº¡i 1 thá»i Ä‘iá»ƒm)
       â”‚                       â”‚ (Standalone)â”‚
       â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 9. Download khÃ³a há»c (60+ phÃºt)
       â”‚                              â”‚    â†“
       â”‚                              â”‚    Upload lÃªn Drive (rclone)
       â”‚                              â”‚
       â”‚                              â”‚ 10. Webhook: finalize
       â”‚                              â–¼
       â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚   Node.js   â”‚
       â”‚                       â”‚   Backend   â”‚
       â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 11. Cáº¥p quyá»n Drive
       â”‚                              â”‚     Gá»­i email
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                       ğŸš¨ Váº¤N Äá»€ NGHIÃŠM TRá»ŒNG                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  âŒ Python Worker ÄÆ¡n = ngháº½n 60 phÃºt/task                   â•‘
â•‘     â€¢ 100 Ä‘Æ¡n hÃ ng = 100 giá» xá»­ lÃ½                            â•‘
â•‘     â€¢ KhÃ´ng thá»ƒ scale ngang                                   â•‘
â•‘                                                               â•‘
â•‘  âŒ Database Polling = KhÃ´ng Hiá»‡u Quáº£                         â•‘
â•‘     â€¢ 8,640 query má»—i ngÃ y (ngay cáº£ khi idle)                 â•‘
â•‘     â€¢ Delay 10 giÃ¢y trÆ°á»›c khi nháº­n task                       â•‘
â•‘                                                               â•‘
â•‘  âŒ KhÃ´ng GiÃ¡m SÃ¡t = Lá»—i Im Láº·ng                              â•‘
â•‘     â€¢ Python crash = khÃ´ng cáº£nh bÃ¡o                           â•‘
â•‘     â€¢ Task káº¹t mÃ£i mÃ£i                                        â•‘
â•‘                                                               â•‘
â•‘  âŒ Báº£o Máº­t Yáº¿u                                               â•‘
â•‘     â€¢ Secrets trong command line (tháº¥y Ä‘Æ°á»£c trong ps aux)     â•‘
â•‘     â€¢ Static webhook secret (khÃ´ng rotation)                  â•‘
â•‘     â€¢ KhÃ´ng request signing (replay attack)                   â•‘
â•‘                                                               â•‘
â•‘  âŒ Xá»­ LÃ½ Lá»—i KÃ©m                                             â•‘
â•‘     â€¢ Task tháº¥t báº¡i khÃ´ng retry                               â•‘
â•‘     â€¢ Lá»—i network gÃ¢y tháº¥t báº¡i vÄ©nh viá»…n                      â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## âœ… KIáº¾N TRÃšC KHUYáº¾N NGHá»Š (Giáº£i PhÃ¡p)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Há»† THá»NG Cáº¢I THIá»†N                               â”‚
â”‚                   (Sáºµn SÃ ng Production)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    KhÃ¡ch hÃ ng                                SePay
       â”‚                                         â”‚
       â”‚ 1. Táº¡o ÄÆ¡n HÃ ng                         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
       â”‚                  â–¼                      â”‚
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚           â”‚   Node.js   â”‚               â”‚
       â”‚           â”‚   Backend   â”‚               â”‚
       â”‚           â”‚             â”‚               â”‚
       â”‚           â”‚  + Health   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€ Prometheus/Grafana
       â”‚           â”‚    Check    â”‚         (GiÃ¡m SÃ¡t)
       â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â”‚                  â”‚ 2. Táº¡o Task
       â”‚                  â–¼
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚           â”‚   MySQL     â”‚
       â”‚           â”‚  Database   â”‚
       â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Tráº£ Vá» QR
       â”‚
       â”‚ 4. KhÃ¡ch thanh toÃ¡n
       â”‚ qua app banking
       â”‚
       â”‚                              5. Webhook (HMAC signed)
       â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â–¼
       â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚   Node.js   â”‚
       â”‚                       â”‚   Backend   â”‚
       â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 6. Cáº­p nháº­t: paid â†’ processing
       â”‚                              â”‚    + Push vÃ o Redis Queue âœ…
       â”‚                              â–¼
       â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                   â”‚                      â”‚
       â”‚                   â”‚   Redis Queue        â”‚
       â”‚                   â”‚   (BullMQ/RQ)        â”‚
       â”‚                   â”‚                      â”‚
       â”‚                   â”‚  âœ… Giao ngay láº­p tá»©c â”‚
       â”‚                   â”‚  âœ… Há»— trá»£ priority   â”‚
       â”‚                   â”‚  âœ… Tá»± Ä‘á»™ng retry     â”‚
       â”‚                   â”‚  âœ… Job metrics       â”‚
       â”‚                   â”‚                      â”‚
       â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 7. Worker pull task
       â”‚                              â”‚
       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â–¼               â–¼               â–¼              â–¼
       â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” ...
       â”‚      â”‚   Python     â”‚ â”‚   Python     â”‚ â”‚   Python     â”‚
       â”‚      â”‚   Worker 1   â”‚ â”‚   Worker 2   â”‚ â”‚   Worker N   â”‚
       â”‚      â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
       â”‚      â”‚ + Health     â”‚ â”‚ + Health     â”‚ â”‚ + Health     â”‚
       â”‚      â”‚   :8881      â”‚ â”‚   :8882      â”‚ â”‚   :888N      â”‚
       â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚             â”‚                â”‚                â”‚
       â”‚             â”‚    âœ… Xá»¬ LÃ SONG SONG          â”‚
       â”‚             â”‚                â”‚                â”‚
       â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 8. Download + Upload
       â”‚                              â”‚    (60 phÃºt má»—i cÃ¡i, nhÆ°ng song song)
       â”‚                              â”‚
       â”‚                              â”‚ 9. Webhook: finalize (HMAC + timestamp)
       â”‚                              â–¼
       â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚   Node.js   â”‚
       â”‚                       â”‚   Backend   â”‚
       â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚                              â”‚ 10. XÃ¡c minh HMAC + Timestamp
       â”‚                              â”‚     Cáº¥p quyá»n Drive
       â”‚                              â”‚     Gá»­i email
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   systemd / Supervisor             â”‚
             â”‚   (Tá»± khá»Ÿi Ä‘á»™ng láº¡i worker khi crash) â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      âœ… Cáº¢I THIá»†N                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  âœ… Scale Ngang                                               â•‘
â•‘     â€¢ 10 worker = thÃ´ng lÆ°á»£ng tÄƒng 10x                        â•‘
â•‘     â€¢ 100 Ä‘Æ¡n hÃ ng = 10 giá» (thay vÃ¬ 100 giá»)                 â•‘
â•‘                                                               â•‘
â•‘  âœ… Giao Task Ngay Láº­p Tá»©c                                    â•‘
â•‘     â€¢ Redis queue push task ngay láº­p tá»©c                      â•‘
â•‘     â€¢ KhÃ´ng delay polling 10 giÃ¢y                             â•‘
â•‘                                                               â•‘
â•‘  âœ… Tá»± Khá»Ÿi Äá»™ng Láº¡i & GiÃ¡m SÃ¡t                               â•‘
â•‘     â€¢ systemd khá»Ÿi Ä‘á»™ng láº¡i worker khi crash                  â•‘
â•‘     â€¢ Health check má»—i 60 giÃ¢y                                â•‘
â•‘     â€¢ Prometheus + Grafana dashboard                          â•‘
â•‘                                                               â•‘
â•‘  âœ… Báº£o Máº­t Máº¡nh                                              â•‘
â•‘     â€¢ HMAC-SHA256 webhook signing                             â•‘
â•‘     â€¢ Timestamp validation (cá»­a sá»• 5 phÃºt)                    â•‘
â•‘     â€¢ KhÃ´ng secrets trong command line                        â•‘
â•‘                                                               â•‘
â•‘  âœ… Xá»­ LÃ½ Lá»—i Máº¡nh Máº½                                         â•‘
â•‘     â€¢ Tá»± Ä‘á»™ng retry vá»›i exponential backoff                   â•‘
â•‘     â€¢ Task tháº¥t báº¡i vÃ o dead-letter queue                     â•‘
â•‘     â€¢ Lá»—i network kÃ­ch hoáº¡t retry                             â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“ˆ So SÃ¡nh Hiá»‡u Suáº¥t

### Ká»‹ch Báº£n: 100 ÄÆ¡n HÃ ng Nháº­n Äá»“ng Thá»i

| Chá»‰ Sá»‘ | Há»‡ Thá»‘ng Hiá»‡n Táº¡i | Há»‡ Thá»‘ng Cáº£i Thiá»‡n | Cáº£i Thiá»‡n |
|--------|-------------------|-------------------|-----------|
| **Thá»i Gian Xá»­ LÃ½** | 6,000 phÃºt (4+ ngÃ y) | 600 phÃºt (10 giá») | **Nhanh hÆ¡n 10x** |
| **KhÃ¡ch Äáº§u Chá»** | ~60 phÃºt | ~60 phÃºt | NhÆ° nhau |
| **KhÃ¡ch Cuá»‘i Chá»** | ~6,000 phÃºt | ~600 phÃºt | **Nhanh hÆ¡n 10x** |
| **Phá»¥c Há»“i Crash** | Khá»Ÿi Ä‘á»™ng láº¡i thá»§ cÃ´ng | Tá»± Ä‘á»™ng (10s) | **99.9% uptime** |
| **Delay Nháº­n Task** | 10 giÃ¢y | < 1 giÃ¢y | **Nhanh hÆ¡n 10x** |
| **Query DB (idle)** | 8,640/ngÃ y | 0/ngÃ y | **Giáº£m 100%** |
| **Retry Task Tháº¥t Báº¡i** | Thá»§ cÃ´ng | Tá»± Ä‘á»™ng (3 láº§n) | **100% coverage** |
| **Äiá»ƒm Báº£o Máº­t** | 3/10 | 9/10 | **Cáº£i thiá»‡n 3x** |

---

## ğŸ”§ CÃ¡c BÆ°á»›c Migration

### Giai Äoáº¡n 1: Sá»­a Ngay (Tuáº§n 1)

```bash
# 1. Thiáº¿t láº­p systemd Ä‘á»ƒ tá»± khá»Ÿi Ä‘á»™ng láº¡i
sudo cat > /etc/systemd/system/udemy-worker.service << 'EOF'
[Unit]
Description=Udemy Download Worker
After=network.target mysql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/root/server/udemy_dl
ExecStart=/usr/bin/python3 /root/server/udemy_dl/worker.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable udemy-worker.service
sudo systemctl start udemy-worker.service

# 2. Triá»ƒn khai HMAC authentication
# (Xem DOWNLOAD_WORKFLOW_ANALYSIS_VI.md Ä‘á»ƒ biáº¿t code)

# 3. ThÃªm health check endpoint
# (Xem code trong khuyáº¿n nghá»‹ Æ¯u tiÃªn 2)
```

---

### Giai Äoáº¡n 2: Message Queue (Tuáº§n 2-3)

```bash
# CÃ i Ä‘áº·t Redis
sudo apt-get install redis-server

# CÃ i Ä‘áº·t BullMQ (Node.js)
npm install bullmq

# CÃ i Ä‘áº·t RQ (Python)
pip install rq
```

**PhÃ­a Node.js:**
```javascript
// src/queues/download.queue.js
const { Queue } = require('bullmq');

const downloadQueue = new Queue('downloads', {
  connection: {
    host: 'localhost',
    port: 6379
  }
});

module.exports = downloadQueue;
```

**PhÃ­a Python:**
```python
# worker_rq.py
import redis
from rq import Worker, Queue, Connection

conn = redis.Redis()

if __name__ == '__main__':
    with Connection(conn):
        worker = Worker([Queue('downloads')])
        worker.work()
```

**Cháº¡y nhiá»u worker:**
```bash
# Start 5 worker
for i in {1..5}; do
    python worker_rq.py &
done
```

---

### Giai Äoáº¡n 3: GiÃ¡m SÃ¡t (Tuáº§n 3-4)

```bash
# CÃ i Ä‘áº·t Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz
tar xvfz prometheus-*.tar.gz
cd prometheus-*

# Cáº¥u hÃ¬nh prometheus.yml
cat > prometheus.yml << 'EOF'
scrape_configs:
  - job_name: 'python-workers'
    static_configs:
      - targets: ['localhost:8881', 'localhost:8882', 'localhost:8883']
EOF

# Start Prometheus
./prometheus --config.file=prometheus.yml
```

---

## ğŸ“Š Dashboard GiÃ¡m SÃ¡t

### Chá»‰ Sá»‘ ChÃ­nh Cáº§n Theo DÃµi

1. **Sá»©c Khá»e Worker**
   ```
   up{job="python-workers"}
   â†’ Hiá»ƒn thá»‹ worker nÃ o Ä‘ang online
   ```

2. **Äá»™ SÃ¢u Queue**
   ```
   redis_queue_length{queue="downloads"}
   â†’ Sá»‘ lÆ°á»£ng task Ä‘ang pending
   ```

3. **Thá»i Gian Xá»­ LÃ½**
   ```
   histogram_quantile(0.95, download_duration_seconds)
   â†’ Thá»i gian download percentile 95
   ```

4. **Tá»· Lá»‡ ThÃ nh CÃ´ng**
   ```
   rate(tasks_completed_total[5m]) / rate(tasks_started_total[5m])
   â†’ Pháº§n trÄƒm download thÃ nh cÃ´ng
   ```

5. **TÃ i NguyÃªn Há»‡ Thá»‘ng**
   ```
   process_resident_memory_bytes{job="python-workers"}
   â†’ Sá»­ dá»¥ng memory má»—i worker
   ```

---

## ğŸ¯ Chá»‰ Sá»‘ ThÃ nh CÃ´ng

### Sau Triá»ƒn Khai, Báº¡n Sáº½ Tháº¥y:

| Chá»‰ Sá»‘ | Má»¥c TiÃªu | CÃ¡ch Äo |
|--------|----------|---------|
| **Thá»i Gian Xá»­ LÃ½ TB** | < 70 phÃºt/task | Prometheus `download_duration_seconds` |
| **Worker Uptime** | > 99.5% | Prometheus `up` metric |
| **Task Tháº¥t Báº¡i** | < 2% | `SELECT COUNT(*) FROM tasks WHERE status='failed'` |
| **Thá»i Gian Chá» Queue** | < 5 phÃºt | Prometheus `queue_wait_seconds` |
| **Retry ThÃ nh CÃ´ng** | > 80% | `SELECT * FROM tasks WHERE retry_count > 0 AND status='completed'` |

---

## ğŸ” Checklist Báº£o Máº­t

- [x] Secrets khÃ´ng trong command line (an toÃ n vá»›i `ps aux`)
- [x] HMAC authentication trÃªn webhook
- [x] Timestamp validation (cá»­a sá»• 5 phÃºt)
- [x] Database user vá»›i quyá»n tá»‘i thiá»ƒu
- [x] TLS trÃªn táº¥t cáº£ external API
- [x] API rate limiting enabled
- [x] Audit báº£o máº­t Ä‘á»‹nh ká»³ Ä‘Ã£ lÃªn lá»‹ch

---

## ğŸš€ Káº¿ Hoáº¡ch Rollback

Náº¿u há»‡ thá»‘ng má»›i cÃ³ váº¥n Ä‘á»:

```bash
# 1. Dá»«ng worker má»›i
sudo systemctl stop udemy-worker.service

# 2. HoÃ n vá» worker cÅ©
cd /root/server/udemy_dl
git checkout main  # hoáº·c commit trÆ°á»›c Ä‘Ã³
python3 worker.py &

# 3. Drain Redis queue vá» MySQL
# (Script tÃ¹y chá»‰nh Ä‘á»ƒ chuyá»ƒn task láº¡i)

# 4. GiÃ¡m sÃ¡t trong 24 giá»
```

---

## ğŸ“ LiÃªn Há»‡ Há»— Trá»£

| Váº¥n Äá» | LiÃªn Há»‡ | Æ¯u TiÃªn |
|--------|---------|---------|
| Worker crash | DevOps Team | P0 (Ngay láº­p tá»©c) |
| Queue backlog | Backend Team | P1 (< 1 giá») |
| Lá»—i database | DBA Team | P1 (< 1 giá») |
| Lá»—i Drive API | Infrastructure | P2 (< 4 giá») |

---

## ğŸ“š TÃ i NguyÃªn ThÃªm

- **PhÃ¢n TÃ­ch Äáº§y Äá»§:** `DOWNLOAD_WORKFLOW_ANALYSIS_VI.md`
- **Tham Kháº£o Nhanh:** `WORKFLOW_QUICK_REFERENCE_VI.md`
- **TÃ i Liá»‡u API:** `postman/README.md`
- **Kháº¯c Phá»¥c Sá»± Cá»‘:** `WORKFLOW_QUICK_REFERENCE_VI.md#kháº¯c-phá»¥c-sá»±-cá»‘`

---

**PhiÃªn Báº£n TÃ i Liá»‡u:** 1.0  
**Cáº­p Nháº­t Láº§n Cuá»‘i:** 12 ThÃ¡ng 1, 2026  
**Tráº¡ng ThÃ¡i:** ğŸŸ¢ Sáºµn SÃ ng Äá»ƒ Triá»ƒn Khai
